# Coverage Validator Agent

Goal: Run generated tests to validate they pass and measure coverage improvement. Enforce quality gates: coverage_delta >= 0 and all tests pass.

## Deliverables

- Test execution report in `.agents/coverage_gaps/validation.json` containing:
  - Test execution results (pass/fail counts)
  - Coverage metrics before and after
  - Coverage delta per file and overall
  - Gate validation results (pass/fail)
  - Failed tests with error messages
- Validation summary in `.agents/coverage_gaps/validation_summary.md`
- **PR creation** if all gates pass
- **Rollback** if gates fail (remove generated test files and report)

## Input

Read test generation results from previous step:
- `.agents/coverage_gaps/test_generation.json`: List of generated test files

## Validation Process

### 1. Backup Current State
Before running tests, capture baseline:
- Run coverage report on existing tests (before new tests)
- Store baseline coverage metrics in memory for comparison

### 2. Run Full Test Suite
Execute tests using detected test framework:
- **Python**: `pytest --cov=. --cov-report=json --cov-report=xml --cov-report=term`
- **JavaScript**: `npm test -- --coverage` or `jest --coverage`
- **Java**: `mvn test jacoco:report` or `gradle test jacocoTestReport`
- **Go**: `go test -coverprofile=coverage.out ./...`
- **Ruby**: `bundle exec rspec` or `rake test`

Capture:
- Test execution status (exit code)
- Total tests run, passed, failed, skipped
- Test execution output (stdout/stderr)
- Generated coverage reports

### 3. Parse Coverage Reports
Parse the new coverage report and compare to baseline:
- Calculate coverage delta: `new_coverage - baseline_coverage`
- Per-file coverage changes
- Overall project coverage change

### 4. Validate Quality Gates

**Gate 1: All Tests Pass**
- Exit code must be 0
- No failed tests
- No errors during test execution

**Gate 2: Coverage Delta >= 0**
- Overall coverage must not decrease
- `coverage_delta >= 0.0`
- Allow for small floating-point tolerance (e.g., -0.01% acceptable)

### 5. Take Action Based on Results

**If both gates PASS**:
1. Create a new git branch: `coverage-gap-filler-{timestamp}`
2. Stage all generated test files
3. Commit with message:
   ```
   feat: Add unit tests to improve coverage

   Generated {N} test files with {M} test cases to address coverage gaps.

   Coverage improvement: +{X}%
   - Files improved: {list}
   - All tests passing: ‚úÖ
   - Coverage delta: +{X}%

   ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

   Co-Authored-By: Claude <noreply@anthropic.com>
   ```
4. Push branch
5. Create PR using `gh pr create` with detailed description

**If any gate FAILS**:
1. Document failure in validation report
2. Rollback: Delete all generated test files
3. Create rollback report explaining failures
4. Exit with failure status (do NOT create PR)

## PR Description Template

When creating PR (only if gates pass):
```markdown
## Summary

This PR adds {N} test files with {M} test cases to improve test coverage across the codebase.

### Coverage Improvement
- **Before**: {baseline_coverage}%
- **After**: {new_coverage}%
- **Delta**: +{delta}%

### Files Improved
{list of files with coverage improvements}

### Quality Gates
- ‚úÖ All tests passing ({total_tests} tests)
- ‚úÖ Coverage delta >= 0 (+{delta}%)

### Test Generation Details
Generated by Coverage Gap Filler workflow targeting:
- Files below {threshold}% coverage
- Recent diff coverage regressions
- High-complexity, frequently-changed modules

## Test Plan
- [x] All existing tests still pass
- [x] All new tests pass
- [x] Coverage has improved or stayed the same

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
```

## Constraints

- Total timeout for test execution: 10 minutes (configurable)
- If tests timeout, consider it a gate failure
- Use same test command as project's CI/CD (check `.github/workflows/`, `package.json` scripts, etc.)
- Preserve test output logs for debugging
- **DO NOT** modify source code or existing tests
- **DO NOT** commit coverage report artifacts to git (add to .gitignore if needed)

### Security Considerations

**‚ö†Ô∏è IMPORTANT SECURITY WARNINGS:**
- Validate test commands before execution (no arbitrary command injection)
- DO NOT commit secrets or credentials that may be in test output
- Ensure git author info is properly configured
- Use `gh` CLI with proper authentication for PR creation

## Output Format

### validation.json
```json
{
  "baseline_coverage": 58.3,
  "new_coverage": 86.8,
  "coverage_delta": 28.5,
  "tests_run": 245,
  "tests_passed": 245,
  "tests_failed": 0,
  "tests_skipped": 2,
  "gate_all_tests_pass": true,
  "gate_coverage_delta_positive": true,
  "gates_passed": true,
  "pr_created": true,
  "pr_url": "https://github.com/user/repo/pull/123",
  "branch_name": "coverage-gap-filler-20251001-143022",
  "files_improved": [
    {
      "file": "src/services/payment_processor.py",
      "baseline_coverage": 45.2,
      "new_coverage": 87.5,
      "delta": 42.3
    }
  ],
  "test_failures": []
}
```

### validation_summary.md
```markdown
# Coverage Validation Results

**Validation Date**: 2025-10-01 14:30:22
**Status**: ‚úÖ PASSED

## Quality Gates

### Gate 1: All Tests Pass ‚úÖ
- Tests run: 245
- Tests passed: 245
- Tests failed: 0
- Tests skipped: 2

### Gate 2: Coverage Delta >= 0 ‚úÖ
- Baseline coverage: 58.3%
- New coverage: 86.8%
- **Coverage delta: +28.5%**

## Coverage Improvements by File

1. **src/services/payment_processor.py**: 45.2% ‚Üí 87.5% (+42.3%)
2. **src/utils/validator.py**: 62.1% ‚Üí 91.2% (+29.1%)
...

## Pull Request

**Status**: ‚úÖ Created
**Branch**: coverage-gap-filler-20251001-143022
**PR URL**: https://github.com/user/repo/pull/123

## Next Steps

1. Review PR and generated tests
2. Merge PR to integrate coverage improvements
3. Monitor coverage in future commits
```

### Rollback Example (if gates fail)

```markdown
# Coverage Validation Results

**Validation Date**: 2025-10-01 14:30:22
**Status**: ‚ùå FAILED

## Quality Gates

### Gate 1: All Tests Pass ‚ùå
- Tests run: 245
- Tests passed: 243
- **Tests failed: 2**
- Tests skipped: 2

**Failed Tests**:
1. `tests/services/test_payment_processor.py::test_process_payment_network_error`
   - Error: `AttributeError: 'NoneType' object has no attribute 'status_code'`
2. `tests/utils/test_validator.py::test_validate_email_invalid`
   - Error: `AssertionError: Expected False, got True`

### Gate 2: Coverage Delta >= 0 ‚ö†Ô∏è
- Baseline coverage: 58.3%
- New coverage: 86.8%
- Coverage delta: +28.5%

## Action Taken

**Rollback**: All generated test files have been removed.

## Reason

Quality gates failed due to test failures. Manual intervention required to fix generated tests.

## Recommendations

1. Review failed tests and fix errors
2. Ensure mocks and fixtures are properly configured
3. Re-run test generation with corrected dependencies
```

## Completion

Write a run report JSON to `${REPORT_PATH}` with:

**If gates PASS**:
```json
{
  "status": "success",
  "gates_passed": true,
  "coverage_delta": 28.5,
  "pr_created": true,
  "pr_url": "https://github.com/user/repo/pull/123",
  "artifacts": [
    ".agents/coverage_gaps/validation.json",
    ".agents/coverage_gaps/validation_summary.md"
  ],
  "notes": "All quality gates passed. PR created at https://github.com/user/repo/pull/123"
}
```

**If gates FAIL**:
```json
{
  "status": "failure",
  "gates_passed": false,
  "gate_failures": ["all_tests_pass"],
  "tests_failed": 2,
  "rollback_completed": true,
  "artifacts": [
    ".agents/coverage_gaps/validation.json",
    ".agents/coverage_gaps/validation_summary.md"
  ],
  "notes": "Quality gates failed. 2 tests failed. Rolled back generated test files."
}
```
